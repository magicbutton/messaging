# Magic Button Messaging - Project Structure

This document provides an overview of the project structure, key files, and their purposes.

## Directory Structure

```
/messaging/
├── dist/               # Compiled output (generated)
├── docs/               # Documentation files
│   ├── api/            # API documentation (generated by TypeDoc)
│   └── guides/         # Usage guides and tutorials
├── examples/           # Example implementations
├── src/                # Source code
└── tests/              # Test files
```

## Key Files

### Core Files

| File | Description |
|------|-------------|
| **index.ts** | Main entry point that exports all public APIs |
| **types.ts** | Core type definitions (interfaces, types) |
| **utils.ts** | Utility functions for creating contracts and messages |
| **client.ts** | Client implementation for connecting to servers |
| **server.ts** | Server implementation for handling requests and managing clients |

### Features

| File | Description |
|------|-------------|
| **transport-adapter.ts** | Interface for communication protocol abstraction |
| **in-memory-transport.ts** | In-memory transport implementation for testing |
| **system-contract.ts** | System-level events and requests |
| **access-control.ts** | Role-based access control system |
| **middleware.ts** | Request/response processing pipeline |
| **observability.ts** | Logging, metrics, and tracing utilities |
| **errors.ts** | Error handling utilities and error registry |
| **versioned-schema.ts** | Schema versioning for backward compatibility |
| **testing.ts** | Testing utilities including MockTransport |

## Type Hierarchy

The core types are organized as follows:

- **Messaging**
  - **Contracts**
    - `EventSchemas` - Map of event names to schemas
    - `RequestSchemas` - Map of request names to request/response schemas
    - `VersionedSchema` - Schema with version information
  - **Messages**
    - `EventPayload` - Event message structure
    - `RequestPayload` - Request message structure
    - `ResponsePayload` - Response message structure
    - `MessageContext` - Context information for messages
  - **Infrastructure**
    - `TransportAdapter` - Interface for transport implementations
    - `Client` - Client for connecting to messaging servers
    - `Server` - Server for handling requests and events
    - `MiddlewareManager` - Middleware processing pipeline
  - **Security**
    - `Actor` - Entity with permissions
    - `Role` - Named set of permissions
    - `System` - Collection of resources, actions, roles
    - `AccessControl` - Permission checking system
  - **Errors**
    - `ErrorType` - Error categorization
    - `ErrorSeverity` - Error severity levels
    - `ErrorDefinition` - Error code definition
    - `MessagingError` - Error implementation
    - `ErrorRegistry` - Error definition registry
  - **Observability**
    - `Logger` - Logging interface
    - `Metrics` - Metrics interface
    - `Tracer` - Distributed tracing interface
    - `ObservabilityProvider` - Combined interface

## Architecture Overview

The library follows these design principles:

1. **Separation of Concerns**
   - Transport logic is separated from business logic
   - Contracts define the communication protocol
   - Middleware handles cross-cutting concerns

2. **Dependency Inversion**
   - High-level modules depend on abstractions
   - Low-level modules implement those abstractions
   - Example: Client/Server depend on TransportAdapter interface

3. **Type Safety**
   - Extensive use of TypeScript generics
   - Contract-first approach with Zod schemas
   - Strong typing throughout the codebase

4. **Testability**
   - In-memory transport for isolated testing
   - MockTransport for controlled testing
   - TestMessaging for integration testing

5. **Extensibility**
   - Middleware system for extending behavior
   - Custom transports can be implemented
   - Observability can be extended with custom providers

## Data Flow

The typical data flow for a request:

1. **Client**: Creates a request with payload and context
2. **Transport**: Serializes and sends the request
3. **Server**: Receives and deserializes the request
4. **Middleware**: Processes the request (auth, validation, etc.)
5. **Handler**: Handles the request and generates a response
6. **Middleware**: Processes the response
7. **Transport**: Serializes and sends the response
8. **Client**: Receives and deserializes the response

The event flow follows a similar pattern but is one-way (no response):

1. **Publisher**: Creates an event with payload and context
2. **Transport**: Sends the event to subscribers
3. **Subscribers**: Receive and process the event

## Internal Dependencies

| Component | Dependencies |
|-----------|--------------|
| Client | TransportAdapter, MessageContext |
| Server | TransportAdapter, MessageContext |
| AccessControl | Actor, Role, System |
| MiddlewareManager | EventMiddleware, RequestMiddleware |
| ErrorRegistry | ErrorDefinition, MessagingError |
| ObservabilityProvider | Logger, Metrics, Tracer |

## External Dependencies

- **zod**: Schema validation
- **uuid**: Unique identifier generation